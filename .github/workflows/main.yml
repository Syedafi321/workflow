name: Pull request from Main to Env Branches

on:
  push:
    branches:
      - main

jobs:
  pr-to-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Create Pull Requests
        run: |
          git fetch origin
          for branch in $(git branch -r | grep 'origin/env/' | sed 's|origin/||'); do
            echo "Creating pull request from main to $branch"
            git checkout main
            git branch -D "$branch" || true
            git checkout -B "$branch"
            git push origin "$branch" --force
            pr_title="PR from Main to $branch"
            pr_body="This pull request was automatically generated by a GitHub Actions workflow."
            pr_head="$branch"
            pr_base="main"
            curl -X POST \
              -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls" \
              -d "{\"title\":\"$pr_title\",\"body\":\"$pr_body\",\"head\":\"$pr_head\",\"base\":\"$pr_base\"}"
          done

    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
